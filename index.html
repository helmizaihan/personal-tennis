<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Helmi’s Tennis Matches</title>

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:'Inter',system-ui,Arial,sans-serif;background:#f7fafc;color:#111827}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);padding:1rem}
    .field{border:1px solid #d1d5db;border-radius:10px;padding:.6rem .8rem;width:100%}
    .btn{border:1px solid #d1d5db;border-radius:10px;padding:.55rem .9rem}
    .btn-primary{background:#2563eb;color:#fff;border:none}
    @media (max-width:640px){h1{font-size:1.1rem}.grid{gap:.5rem} table{font-size:.9rem} th,td{padding:.35rem .5rem}}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="card mb-4 flex flex-col sm:flex-row gap-2 sm:gap-4 items-start sm:items-center justify-between">
    <h1 class="text-xl font-bold">Helmi’s Tennis Matches</h1>
    <div class="flex gap-2 flex-wrap">
      <button id="btnExport" class="btn">Export to Excel</button>
      <button id="btnPrint" class="btn">Save PDF</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto space-y-4 px-2 sm:px-0">
    <!-- Opponents -->
    <section class="card">
      <h2 class="font-semibold mb-2">Opponents</h2>
      <div class="flex flex-col sm:flex-row gap-2 mb-2">
        <input id="playerInput" class="field" placeholder="Add opponent name" />
        <button id="addPlayer" class="btn-primary">Add</button>
      </div>
      <p class="text-xs text-gray-600 mb-2">Tap a name to select it in the match form.</p>
      <ul id="playerList" class="space-y-1 text-sm"></ul>
    </section>

    <!-- Add Match -->
    <section class="card">
      <h2 class="font-semibold mb-2">Add Match</h2>
      <div class="grid md:grid-cols-3 gap-3 mb-2">
        <input id="mDate" type="date" class="field" />
        <select id="mOpponent" class="field"></select>
        <select id="mFormat" class="field">
          <option value="1">Single Set</option>
          <option value="3">Best of 3</option>
          <option value="5">Best of 5</option>
        </select>
        <select id="mResult" class="field"><option value="W">Win</option><option value="L">Loss</option></select>
        <input id="mScore" class="field" placeholder="Score e.g., 6-4; 3-6; 10-8" />
        <select id="mSurface" class="field"><option>Hard</option><option>Clay</option><option>Grass</option><option>Carpet</option></select>
        <input id="mNotes" class="field md:col-span-3" placeholder="Notes (wind, strings, strategy, cramps…)" />
      </div>
      <button id="addMatch" class="btn-primary">Add Match</button>
    </section>

    <!-- Stats -->
    <section class="card">
      <h2 class="font-semibold mb-3">Statistics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div><div class="text-xs text-gray-600">Win–Loss</div><div id="statWL" class="text-lg font-bold">0–0</div></div>
        <div><div class="text-xs text-gray-600">Winning %</div><div id="statWinPct" class="text-lg font-bold">0%</div></div>
        <div><div class="text-xs text-gray-600">Matches</div><div id="statTotal" class="text-lg font-bold">0</div></div>
        <div><div class="text-xs text-gray-600">Current Streak</div><div id="statStreak" class="text-lg font-bold">–</div></div>
      </div>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="min-h-[220px]"><canvas id="chartMonth"></canvas></div>
        <div class="min-h-[220px]"><canvas id="chartSurface"></canvas></div>
      </div>
    </section>

    <!-- Breakdowns tables -->
    <section class="card">
      <h2 class="font-semibold mb-3">Breakdowns</h2>
      <div class="grid lg:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold mb-2">By Month</h3>
          <div class="overflow-x-auto"><table class="min-w-full text-sm">
            <thead class="text-left text-gray-600 border-b"><tr><th class="py-2 pr-3">Month</th><th class="py-2 pr-3">W</th><th class="py-2 pr-3">L</th><th class="py-2 pr-3">Win %</th><th class="py-2 pr-3">Matches</th></tr></thead>
            <tbody id="monthlyBody" class="divide-y"></tbody>
          </table></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">By Surface</h3>
          <div class="overflow-x-auto"><table class="min-w-full text-sm">
            <thead class="text-left text-gray-600 border-b"><tr><th class="py-2 pr-3">Surface</th><th class="py-2 pr-3">W</th><th class="py-2 pr-3">L</th><th class="py-2 pr-3">Win %</th><th class="py-2 pr-3">Matches</th></tr></thead>
            <tbody id="surfaceBody" class="divide-y"></tbody>
          </table></div>
        </div>
      </div>
    </section>

    <!-- Match History -->
    <section class="card">
      <h2 class="font-semibold mb-2">Match History</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead><tr><th>Date</th><th>Opponent</th><th>Result</th><th>Score</th><th>Surface</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="matchBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Notes Cloud -->
    <section class="card">
      <h2 class="font-semibold mb-2">Notes Cloud</h2>
      <div id="notesCloud" class="min-h-[100px]"></div>
    </section>
  </main>

<script>
// ---------- Storage ----------
const LS_KEY='helmi_tennis_final_v1';
let state=JSON.parse(localStorage.getItem(LS_KEY)||'{"players":[],"matches":[]}');
const el=id=>document.getElementById(id);
function save(){localStorage.setItem(LS_KEY,JSON.stringify(state));}

// ---------- Opponents ----------
function renderPlayers(){
  const list=el('playerList'); list.innerHTML='';
  const select=el('mOpponent'); select.innerHTML='';
  state.players.sort().forEach(p=>{
    const li=document.createElement('li'); li.textContent=p; li.className='cursor-pointer hover:underline'; li.onclick=()=>select.value=p; list.appendChild(li);
    select.append(new Option(p,p));
  });
}

// ---------- Matches ----------
function addMatch(){
  const m={ id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())), date:el('mDate').value, opponent:el('mOpponent').value, format:+el('mFormat').value, result:el('mResult').value, score:el('mScore').value, surface:el('mSurface').value, notes:el('mNotes').value };
  if(!m.opponent){ alert('Pick an opponent'); return; }
  state.matches.push(m); save();
  renderAll();
}

function renderMatches(){
  const body=el('matchBody'); body.innerHTML='';
  const rows=state.matches.slice().sort((a,b)=>a.date<b.date?1:-1);
  rows.forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m.date||''}</td><td>${m.opponent||''}</td><td>${m.result||''}</td><td>${m.score||''}</td><td>${m.surface||''}</td><td>${m.notes||''}</td>
    <td><button class="btn text-xs" data-edit="${m.id}">Edit</button> <button class="btn text-xs" data-del="${m.id}">Delete</button></td>`;
    body.appendChild(tr);
  });
}

// Edit / Delete including score
el('matchBody').addEventListener('click',(e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.edit||b.dataset.del; const idx=state.matches.findIndex(x=>String(x.id)===String(id)); if(idx<0) return;
  if(b.dataset.del){ if(confirm('Delete this match?')){ state.matches.splice(idx,1); save(); renderAll(); } return; }
  const m=state.matches[idx];
  const raw=prompt('Edit (date,opponent,result,score,surface,notes)', `${m.date||''},${m.opponent||''},${m.result||''},${m.score||''},${m.surface||''},${m.notes||''}`);
  if(raw){ const p=raw.split(','); if(p.length>=6){ [m.date,m.opponent,m.result,m.score,m.surface,m.notes]=[p[0],p[1],p[2],p[3],p[4],p.slice(5).join(',')]; save(); renderAll(); } }
});

// ---------- Stats + Charts ----------
function renderStats(){
  const w=state.matches.filter(x=>x.result==='W').length;
  const l=state.matches.filter(x=>x.result==='L').length;
  const total=w+l;
  el('statWL').textContent=`${w}–${l}`;
  el('statWinPct').textContent= total? Math.round(w/total*100)+'%':'0%';
  el('statTotal').textContent= total;
  // streak (based on input order)
  let streak=0, last=null; state.matches.forEach(m=>{ if(last===null||m.result===last){ streak++; } else { streak=1; } last=m.result; });
  el('statStreak').textContent= total? String(streak):'–';
}

function renderCharts(){
  // Monthly
  const monthly={};
  state.matches.forEach(m=>{ const k=(m.date||'').slice(0,7); if(!k) return; monthly[k]=(monthly[k]||{W:0,L:0}); monthly[k][m.result]++; });
  const mLabels=Object.keys(monthly).sort();
  const mWins=mLabels.map(k=>monthly[k].W||0);
  const mLosses=mLabels.map(k=>monthly[k].L||0);
  if(window._monthChart) window._monthChart.destroy();
  window._monthChart=new Chart(document.getElementById('chartMonth'),{type:'bar',data:{labels:mLabels,datasets:[{label:'Wins',data:mWins,backgroundColor:'#2563eb'},{label:'Losses',data:mLosses,backgroundColor:'#ef4444'}]},options:{responsive:true,maintainAspectRatio:false}});
  // Surface
  const surface={};
  state.matches.forEach(m=>{ const k=m.surface||'Unknown'; surface[k]=(surface[k]||{W:0,L:0}); surface[k][m.result]++; });
  const sLabels=Object.keys(surface);
  const sWins=sLabels.map(k=>surface[k].W||0);
  const sLosses=sLabels.map(k=>surface[k].L||0);
  if(window._surfChart) window._surfChart.destroy();
  window._surfChart=new Chart(document.getElementById('chartSurface'),{type:'bar',data:{labels:sLabels,datasets:[{label:'Wins',data:sWins,backgroundColor:'#10b981'},{label:'Losses',data:sLosses,backgroundColor:'#f59e0b'}]},options:{responsive:true,maintainAspectRatio:false}});
}

function renderBreakdowns(){
  // Month table
  const monthly=new Map();
  for(const m of state.matches){ const key=(m.date||'').slice(0,7); if(!key) continue; const row=monthly.get(key)||{W:0,L:0}; row[m.result]=(row[m.result]||0)+1; monthly.set(key,row); }
  const months=[...monthly.keys()].sort();
  const mBody=document.getElementById('monthlyBody'); if(mBody){ const rows=months.map(k=>{ const r=monthly.get(k), W=r.W||0, L=r.L||0, T=W+L, P=T?Math.round(W*100/T):0; const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-2 pr-3">${k}</td><td class="py-2 pr-3">${W}</td><td class="py-2 pr-3">${L}</td><td class="py-2 pr-3">${P}%</td><td class="py-2 pr-3">${T}</td>`; return tr; }); mBody.replaceChildren(...rows); }
  // Surface table
  const surface=new Map();
  for(const m of state.matches){ const key=m.surface||'Unknown'; const r=surface.get(key)||{W:0,L:0}; r[m.result]=(r[m.result]||0)+1; surface.set(key,r); }
  const sBody=document.getElementById('surfaceBody'); if(sBody){ const rows=[...surface.keys()].sort().map(k=>{ const r=surface.get(k), W=r.W||0, L=r.L||0, T=W+L, P=T?Math.round(W*100/T):0; const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-2 pr-3">${k}</td><td class="py-2 pr-3">${W}</td><td class="py-2 pr-3">${L}</td><td class="py-2 pr-3">${P}%</td><td class="py-2 pr-3">${T}</td>`; return tr; }); sBody.replaceChildren(...rows); }
}

// ---------- Notes Cloud ----------
function renderNotes(){
  const words={};
  state.matches.forEach(m=>{ (m.notes||'').toLowerCase().split(/[^a-z0-9]+/).forEach(w=>{ if(w&&w.length>2){ words[w]=(words[w]||0)+1; } }); });
  const entries=Object.entries(words).sort((a,b)=>b[1]-a[1]).slice(0,50);
  const cloud=el('notesCloud'); cloud.innerHTML='';
  if(!entries.length){ cloud.textContent='No notes yet.'; return; }
  const max=entries[0][1];
  entries.forEach(([w,c])=>{ const span=document.createElement('span'); span.textContent=w; span.style.fontSize=(0.8+(c/max)*1.4)+'rem'; span.className='mr-2'; cloud.appendChild(span); });
}

// ---------- Export / Print ----------
document.getElementById('btnExport').onclick=()=>{
  const rows=[["date","opponent","result","score","surface","notes"]];
  state.matches.forEach(m=>rows.push([m.date||'',m.opponent||'',m.result||'',m.score||'',m.surface||'',m.notes||'']));
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='helmi-tennis.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),400);
};

document.getElementById('btnPrint').onclick=()=>window.print();

// ---------- Wire up UI ----------
document.getElementById('addPlayer').onclick=()=>{
  const n=document.getElementById('playerInput').value.trim();
  if(n && !state.players.includes(n)){ state.players.push(n); save(); renderPlayers(); }
  document.getElementById('playerInput').value='';
};

document.getElementById('addMatch').onclick=addMatch;

function renderAll(){ renderPlayers(); renderMatches(); renderStats(); renderCharts(); renderBreakdowns(); renderNotes(); }

// Boot
(function init(){
  document.getElementById('mDate').value=new Date().toISOString().slice(0,10);
  renderAll();
})();
</script>
</body>
</html>
